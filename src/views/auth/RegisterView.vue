<template>
  <AuthLayout container-class="mt-3">
    <div class="authorization-form__header">
      <h5 class="font-medium text-gray-700">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
      <h1 class="h1 font-bold">–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</h1>
    </div>

    <form class="authorization-form__body" @submit.prevent="handleRegister">
      <div class="form">
        <!-- –§–∞–º–∏–ª–∏—è -->
        <div class="form-field">
          <div class="input-field">
            <input  type="text"
                    id="last_name"
                    v-model="formData.last_name"
                    @input="validateName('last_name')"
                    required
                    class="peer w-full px-4 pt-7 pb-3 font-medium text-sm bg-gray-100 rounded-2xl border-1 border-gray-200 focus:outline-none focus:border-gray-300 focus:text-black transition-all duration-200"
                    :class="{ 'border-red-500': errors.last_name }"
                    placeholder=" "/>

            <label  for="last_name"
                    class="absolute left-4 top-1/2 font-medium -translate-y-1/2 text-sm text-gray-700
                  peer-focus:top-4 peer-focus:text-xs
                  peer-[:not(:placeholder-shown)]:top-4 peer-[:not(:placeholder-shown)]:text-xs
                  transition-all duration-200 pointer-events-none">
              –§–∞–º–∏–ª–∏—è <span class="text-red-500">*</span>
            </label>
          </div>
          <div v-if="errors.last_name" class="pt-3">
            <span class="text-sm text-red-500">{{ errors.last_name }}</span>
          </div>
        </div>

        <!-- –ò–º—è -->
        <div class="form-field">
          <div class="input-field">
            <input  type="text"
                    id="first_name"
                    v-model="formData.first_name"
                    @input="validateName('first_name')"
                    required
                    class="peer w-full px-4 pt-7 pb-3 font-medium text-sm bg-gray-100 rounded-2xl border-1 border-gray-200 focus:outline-none focus:border-gray-300 focus:text-black transition-all duration-200"
                    :class="{ 'border-red-500': errors.first_name }"
                    placeholder=" "/>

            <label  for="first_name"
                    class="absolute left-4 top-1/2 font-medium -translate-y-1/2 text-sm text-gray-700
                  peer-focus:top-4 peer-focus:text-xs
                  peer-[:not(:placeholder-shown)]:top-4 peer-[:not(:placeholder-shown)]:text-xs
                  transition-all duration-200 pointer-events-none">
              –ò–º—è <span class="text-red-500">*</span>
            </label>
          </div>
          <div v-if="errors.first_name" class="pt-3">
            <span class="text-sm text-red-500">{{ errors.first_name }}</span>
          </div>
        </div>

        <!-- –û—Ç—á–µ—Å—Ç–≤–æ -->
        <div class="form-field">
          <div class="input-field">
            <input  type="text"
                    id="middle_name"
                    v-model="formData.middle_name"
                    @input="validateName('middle_name')"
                    class="peer w-full px-4 pt-7 pb-3 font-medium text-sm bg-gray-100 rounded-2xl border-1 border-gray-200 focus:outline-none focus:border-gray-300 focus:text-black transition-all duration-200"
                    :class="{ 'border-red-500': errors.middle_name }"
                    placeholder=" "/>

            <label  for="middle_name"
                    class="absolute left-4 top-1/2 font-medium -translate-y-1/2 text-sm text-gray-700
                  peer-focus:top-4 peer-focus:text-xs
                  peer-[:not(:placeholder-shown)]:top-4 peer-[:not(:placeholder-shown)]:text-xs
                  transition-all duration-200 pointer-events-none">
              –û—Ç—á–µ—Å—Ç–≤–æ
            </label>
          </div>
          <div v-if="errors.middle_name" class="pt-3">
            <span class="text-sm text-red-500">{{ errors.middle_name }}</span>
          </div>
        </div>

        <!-- –ò–ò–ù -->
        <div class="form-field">
          <div class="input-field">
            <input  type="text"
                    id="iin"
                    required
                    v-model="formData.iin"
                    maxlength="12"
                    @input="validateIIN"
                    class="peer w-full px-4 pt-7 pb-3 font-medium text-sm bg-gray-100 rounded-2xl border-1 border-gray-200 focus:outline-none focus:border-gray-300 focus:text-black transition-all duration-200"
                    :class="{ 'border-red-500': errors.iin }"
                    placeholder=" "/>

            <label  for="iin"
                    class="absolute left-4 top-1/2 font-medium -translate-y-1/2 text-sm text-gray-700
                    peer-focus:top-4 peer-focus:text-xs
                    peer-[:not(:placeholder-shown)]:top-4 peer-[:not(:placeholder-shown)]:text-xs
                    transition-all duration-200 pointer-events-none">
              –ò–ò–ù <span class="text-red-500">*</span>
            </label>
          </div>
          <div v-if="errors.iin" class="pt-3">
            <span class="text-sm text-red-500">{{ errors.iin }}</span>
          </div>
        </div>

        <div>
          <span class="text-sm text-gray-700">–î–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–∏ –ª–∏—á–Ω–æ—Å—Ç–∏</span>
        </div>
      </div>

      <div class="form">
        <h5 class="text-black text-lg font-medium">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>

        <!-- Email (readonly) -->
        <div class="form-field">
          <div class="input-field">
            <input  type="email"
                    id="email"
                    v-model="formData.email"
                    required
                    readonly
                    class="peer w-full px-4 pt-7 pb-3 font-medium text-sm bg-gray-100 rounded-2xl border-1 border-gray-200 focus:outline-none focus:border-gray-300 focus:text-black transition-all duration-200 cursor-not-allowed"
                    :class="{ 'border-red-500': errors.email }"
                    placeholder=" "/>

            <label  for="email"
                    class="absolute left-4 top-1/2 font-medium -translate-y-1/2 text-sm text-gray-700
                    peer-focus:top-4 peer-focus:text-xs
                    peer-[:not(:placeholder-shown)]:top-4 peer-[:not(:placeholder-shown)]:text-xs
                    transition-all duration-200 pointer-events-none">
              Email <span class="text-red-500">*</span>
            </label>
          </div>
          <div v-if="errors.email" class="pt-3">
            <span class="text-sm text-red-500">{{ errors.email }}</span>
          </div>
          <div v-else class="pt-1">
            <span class="text-xs text-gray-700">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –≤–∞–º –Ω–∞ –ø–æ—á—Ç—É</span>
          </div>
        </div>

        <!-- –¢–µ–ª–µ—Ñ–æ–Ω —Å –º–∞—Å–∫–æ–π -->
        <div class="form-field">
          <div class="input-field">
            <input  type="tel"
                    id="phone"
                    v-model="phoneDisplay"
                    @input="handlePhoneInput"
                    @focus="handlePhoneFocus"
                    maxlength="18"
                    placeholder=" "
                    class="peer w-full px-4 pt-7 pb-3 font-medium text-sm bg-gray-100 rounded-2xl border-1 border-gray-200 focus:outline-none focus:border-gray-300 focus:text-black transition-all duration-200"
                    :class="{ 'border-red-500': errors.phone }"/>

            <label  for="phone"
                    class="absolute left-4 top-1/2 font-medium -translate-y-1/2 text-sm text-gray-700
                    peer-focus:top-4 peer-focus:text-xs
                    peer-[:not(:placeholder-shown)]:top-4 peer-[:not(:placeholder-shown)]:text-xs
                    transition-all duration-200 pointer-events-none">
              –¢–µ–ª–µ—Ñ–æ–Ω
            </label>
          </div>
          <div v-if="errors.phone" class="pt-3">
            <span class="text-sm text-red-500">{{ errors.phone }}</span>
          </div>

        </div>
      </div>

      <!-- –û–±—â–∞—è –æ—à–∏–±–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
      <div v-if="errors.general" class="mb-4">
        <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
          <span class="text-sm text-red-600">{{ errors.general }}</span>
        </div>
      </div>

      <div class="flex flex-col gap-6">
        <button type="submit" :disabled="loading" class="w-full text-sm bg-black text-white font-medium cursor-pointer hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-full py-4">
          {{ loading ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' }}
        </button>
        <ul class="flex flex-col gap-3 text-center [ text-sm font-medium text-black underline ]">
          <li><a href="#" @click.prevent="goBack" class="hover:text-blue-600">–£ –º–µ–Ω—è –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a></li>
        </ul>
      </div>

      <div class="authorization-form__footer">
        <div class="text-center">
          <Politics />
        </div>
      </div>
    </form>
  </AuthLayout>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useRouter } from 'vue-router';
import { accountAPI } from '@/services/api.js';
import AuthLayout from '@/layouts/AuthLayout.vue';
import { usePageMeta } from '@/composables/usePageMeta.js';
import Politics from "@/components/ui/Politics.vue";

usePageMeta('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', '–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ');

const router = useRouter();
const loading = ref(false);

// –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—é
const errors = ref({
  first_name: '',
  last_name: '',
  middle_name: '',
  iin: '',
  email: '',
  phone: '',
  general: ''
});

const formData = ref({
  email: '',
  first_name: '',
  last_name: '',
  middle_name: '',
  iin: '',
  phone: '',
});

// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å –º–∞—Å–∫–æ–π
const phoneDisplay = ref('');

onMounted(() => {
  const savedEmail = sessionStorage.getItem('email');
  if (savedEmail) {
    formData.value.email = savedEmail;
  } else {
    router.push({ name: 'CheckEmail' });
  }
});

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
const clearErrors = () => {
  errors.value = {
    first_name: '',
    last_name: '',
    middle_name: '',
    iin: '',
    email: '',
    phone: '',
    general: ''
  };
};

// –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞, –ª–∞—Ç–∏–Ω–∏—Ü–∞, –¥–µ—Ñ–∏—Å –∏ –ø—Ä–æ–±–µ–ª—ã)
const validateName = (field) => {
  const value = formData.value[field];

  // –†–∞–∑—Ä–µ—à–∞–µ–º –∫–∏—Ä–∏–ª–ª–∏—Ü—É, –ª–∞—Ç–∏–Ω–∏—Ü—É, –¥–µ—Ñ–∏—Å –∏ –ø—Ä–æ–±–µ–ª—ã
  const cleanedValue = value.replace(/[^–∞-—è—ë–ê-–Ø–Åa-zA-Z\s\-]/g, '');
  formData.value[field] = cleanedValue;

  // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –≤–≤–æ–¥–µ
  if (errors.value[field]) {
    errors.value[field] = '';
  }
};

// –í–∞–ª–∏–¥–∞—Ü–∏—è –ò–ò–ù (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
const validateIIN = (event) => {
  const value = event.target.value;
  formData.value.iin = value.replace(/\D/g, '');

  if (errors.value.iin) {
    errors.value.iin = '';
  }
};

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
const formatPhone = (value) => {
  // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
  const numbers = value.replace(/\D/g, '');

  // –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
  if (!numbers) return '';

  // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å–∫—É +7 (XXX) XXX-XX-XX
  let formatted = '+7';

  if (numbers.length > 1) {
    formatted += ' (' + numbers.substring(1, 4);
  }
  if (numbers.length >= 5) {
    formatted += ') ' + numbers.substring(4, 7);
  }
  if (numbers.length >= 8) {
    formatted += '-' + numbers.substring(7, 9);
  }
  if (numbers.length >= 10) {
    formatted += '-' + numbers.substring(9, 11);
  }

  return formatted;
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
const handlePhoneInput = (event) => {
  const value = event.target.value;
  const numbers = value.replace(/\D/g, '');

  // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ 7
  let cleanNumbers = numbers;
  if (numbers && numbers[0] !== '7') {
    cleanNumbers = '7' + numbers;
  }

  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 11 —Ü–∏—Ñ—Ä–∞–º–∏ (7 + 10 —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞)
  cleanNumbers = cleanNumbers.substring(0, 11);

  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  phoneDisplay.value = formatPhone(cleanNumbers);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  formData.value.phone = cleanNumbers ? '+' + cleanNumbers : '';

  // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫—É
  if (errors.value.phone) {
    errors.value.phone = '';
  }
};

// –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –ø–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
const handlePhoneFocus = () => {
  if (!phoneDisplay.value) {
    phoneDisplay.value = '+7 (';
    formData.value.phone = '+7';
  }
};

// –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
const validateForm = () => {
  clearErrors();
  let isValid = true;

  if (!formData.value.last_name.trim()) {
    errors.value.last_name = '–§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞';
    isValid = false;
  } else if (!/^[–∞-—è—ë–ê-–Ø–Åa-zA-Z\s\-]+$/.test(formData.value.last_name)) {
    errors.value.last_name = '–§–∞–º–∏–ª–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã';
    isValid = false;
  }

// –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏
  if (!formData.value.first_name.trim()) {
    errors.value.first_name = '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ';
    isValid = false;
  } else if (!/^[–∞-—è—ë–ê-–Ø–Åa-zA-Z\s\-]+$/.test(formData.value.first_name)) {
    errors.value.first_name = '–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã';
    isValid = false;
  }

// –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç—á–µ—Å—Ç–≤–∞ (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
  if (formData.value.middle_name && !/^[–∞-—è—ë–ê-–Ø–Åa-zA-Z\s\-]+$/.test(formData.value.middle_name)) {
    errors.value.middle_name = '–û—Ç—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã';
    isValid = false;
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ò–ò–ù
  if (!formData.value.iin.trim()) {
    errors.value.iin = '–ò–ò–ù –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω';
    isValid = false;
  } else if (formData.value.iin.length !== 12) {
    errors.value.iin = '–ò–ò–ù –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 12 —Ü–∏—Ñ—Ä';
    isValid = false;
  } else if (!/^\d{12}$/.test(formData.value.iin)) {
    errors.value.iin = '–ò–ò–ù –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã';
    isValid = false;
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è email
  if (!formData.value.email.trim()) {
    errors.value.email = 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω';
    isValid = false;
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω)
  if (formData.value.phone && formData.value.phone !== '+7') {
    const numbers = formData.value.phone.replace(/\D/g, '');
    if (numbers.length !== 11) {
      errors.value.phone = '–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 11 —Ü–∏—Ñ—Ä';
      isValid = false;
    }
  }

  return isValid;
};

const handleRegister = async () => {
  // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
  if (!validateForm()) {
    return;
  }

  loading.value = true;
  clearErrors();

  try {
    // üÜï –î–û–ë–ê–í–¨–¢–ï: –ü–æ–ª—É—á–∞–µ–º referral_token –∏–∑ localStorage –µ—Å–ª–∏ –µ—Å—Ç—å
    const referralToken = localStorage.getItem('referral_token');

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const payload = {
      email: formData.value.email,
      first_name: formData.value.first_name,
      last_name: formData.value.last_name,
      middle_name: formData.value.middle_name || '',
      iin: formData.value.iin,
      phone: formData.value.phone || null,
    };

    // üÜï –î–û–ë–ê–í–¨–¢–ï: –î–æ–±–∞–≤–ª—è–µ–º referral_token –µ—Å–ª–∏ –µ—Å—Ç—å
    if (referralToken) {
      payload.referral_token = referralToken;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å referral_token
    const response = await accountAPI.register(payload);

    sessionStorage.setItem('registration_email', formData.value.email);
    sessionStorage.removeItem('email');

    router.push({ name: 'EmailSent' });

  } catch (err) {
    console.log('–û—à–∏–±–∫–∞:', err.response?.data);

    if (err.response?.data) {
      const serverErrors = err.response.data;

      if (serverErrors.error) {
        errors.value.general = serverErrors.error;
      }
      else if (typeof serverErrors === 'object') {
        Object.keys(serverErrors).forEach(field => {
          const messages = serverErrors[field];
          const errorText = Array.isArray(messages) ? messages.join(', ') : messages;

          if (errors.value.hasOwnProperty(field)) {
            errors.value[field] = errorText;
          } else {
            if (!errors.value.general) {
              errors.value.general = '';
            }
            errors.value.general += `${field}: ${errorText}; `;
          }
        });
      }
    } else {
      errors.value.general = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    }
  } finally {
    loading.value = false;
  }
};

const goBack = () => {
  sessionStorage.removeItem('email');
  router.push({ name: 'CheckEmail' });
};
</script>

<style scoped>
</style>